// ==UserScript==
// @name         neopets_food_club_helper
// @namespace    https://github.com/davidryda/Neopets_Food_Club_Helper
// @version      0.0.1
// @description  A UserScript designed to help with entering bets for the game 'Food Club' on Neopets
// @licence      GPL-3.0-or-later
// @author       David
// @match        http*://www.neopets.com/pirates/foodclub.phtml?type=bet
// @grant        none
// @updateURL    https://github.com/davidryda/Neopets_Food_Club_Helper/raw/master/dist/neopets_food_club_helper.user.js
// @downloadURL  https://github.com/davidryda/Neopets_Food_Club_Helper/raw/master/dist/neopets_food_club_helper.user.js
// ==/UserScript==

(()=>{"use strict";const e=[{Id:1,Name:"Shipwreck",ShortName:"Shipwreck"},{Id:2,Name:"Lagoon",ShortName:"Lagoon"},{Id:3,Name:"Treasure Island",ShortName:"Treasure"},{Id:4,Name:"Hidden Cove",ShortName:"Hidden"},{Id:5,Name:"Harpoon Harry's",ShortName:"Harpoon"}],t=[{Id:1,Name:"Scurvy Dan the Blade",ShortName:"Dan"},{Id:2,Name:"Young Sproggie",ShortName:"Sproggie"},{Id:3,Name:"Orvinn the First Mate",ShortName:"Orvinn"},{Id:4,Name:"Lucky McKyriggan",ShortName:"Lucky"},{Id:5,Name:"Sir Edmund Ogletree",ShortName:"Edmund"},{Id:6,Name:"Peg Leg Percival",ShortName:"Peg Leg"},{Id:7,Name:"Bonnie Pip Culliford",ShortName:"Bonnie"},{Id:8,Name:"Puffo the Waister",ShortName:"Puffo"},{Id:9,Name:"Stuff-A-Roo",ShortName:"Stuff"},{Id:10,Name:"Squire Venable",ShortName:"Squire"},{Id:11,Name:"Captain Crossblades",ShortName:"Crossblades"},{Id:12,Name:"Ol' Stripey",ShortName:"Stripey"},{Id:13,Name:"Ned the Skipper",ShortName:"Ned"},{Id:14,Name:"Fairfax the Deckhand",ShortName:"Fairfax"},{Id:15,Name:"Gooblah the Grarrl",ShortName:"Gooblah"},{Id:16,Name:"Franchisco Corvallio",ShortName:"Franchisco"},{Id:17,Name:"Federismo Corvallio",ShortName:"Federismo"},{Id:18,Name:"Admiral Blackbeard",ShortName:"Blackbeard"},{Id:19,Name:"Buck Cutlass",ShortName:"Buck"},{Id:20,Name:"The Tailhook Kid",ShortName:"Tailhook"}];var o=function(e,t,o,n){return new(o||(o=Promise))((function(r,a){function l(e){try{i(n.next(e))}catch(e){a(e)}}function d(e){try{i(n.throw(e))}catch(e){a(e)}}function i(e){var t;e.done?r(e.value):(t=e.value,t instanceof o?t:new o((function(e){e(t)}))).then(l,d)}i((n=n.apply(e,t||[])).next())}))};new class{constructor(){const e=this.FindMaxFoodClubBetAmount();this.SetMaxBetAmount(e),this.FetchFoodClubBetsRedditThread().then((e=>{null===e&&alert("No food club bets url returned from the neopets subreddit"),this.ParseFoodClubBetsRedditThread(e).then((e=>{this.WriteBetSetsToPage(e)}))}))}FindBetForm(){const e=document.getElementsByName("bet_form");if(1!==e.length){const t=`${e.length} elements with the name of 'bet_form' found! There sould only be one!`;throw alert(t),new Error(t)}return e[0]}FindMaxFoodClubBetAmount(){const e=document.querySelectorAll("p");let t=null;for(let o=0;o<e.length;o++)if(e[o].textContent.includes("50 + 2")){t=e[o];break}if(null===t)return 0;const o=t.querySelectorAll("b");let n;for(let e=0;e<o.length;e++){const t=parseInt(o[e].textContent);isNaN(t)||(n=t)}return null!=n?n:0}SetMaxBetAmount(e){const t=document.getElementsByName("bet_amount");1===t.length?t[0].value=e.toString():alert("Could not find a bet amount!")}WriteBetSetsToPage(t){var o;let n=this.FindBetForm();for(let r of t){let t=document.createElement("div");t.style.marginBottom="10px";let a=document.createElement("table");a.style.width="500px",a.style.border="1px solid black",a.style.borderCollapse="collapse";let l=document.createElement("thead"),d=document.createElement("tbody");a.appendChild(l),a.appendChild(d);let i=document.createElement("tr");for(let t=-2;t<e.length;t++){let o=document.createElement("th");o.style.border="1px solid black",o.style.borderCollapse="collapse",o.innerHTML=-2===t?"":-1===t?"#":e[t].ShortName,i.appendChild(o)}l.appendChild(i);for(let t of r.Rows){const n=t.Bets;let r=document.createElement("tr");for(let a=-2;a<n.length;a++){let l=document.createElement("td");if(l.style.border="1px solid black",l.style.borderCollapse="collapse",-2===a){let e=document.createElement("input");e.type="radio",e.onclick=()=>this.FillOutBets(n),l.appendChild(e)}else if(-1===a)l.innerHTML=t.BetNumber.toString();else{const t=e[a],r=n.find((e=>e.Arena.Id===t.Id));if(void 0===r)throw new Error("Could not find a matching arena, something went wrong!");const d=r.Pirate;l.innerHTML=null!==(o=null==d?void 0:d.ShortName)&&void 0!==o?o:""}r.appendChild(l)}d.appendChild(r)}let s=document.createElement("div");s.style.width="498px",s.style.borderTop="1px solid black",s.style.borderRight="1px solid black",s.style.borderLeft="1px solid black",s.innerHTML=r.Author,t.appendChild(s),t.appendChild(a),n.parentElement.appendChild(t)}}FillOutBets(t){const o=this.FindBetForm().getElementsByTagName("tr");for(let n=0;n<t.length;n++){const r=e[n],a=t.find((e=>e.Arena.Id===r.Id));if(void 0===a)throw new Error("Could not find a matching arena, something went wrong!");let l=null,d=null;for(let e of o)if(e.textContent.includes(a.Arena.Name)){const t=e.getElementsByTagName("select"),o=e.getElementsByTagName("input");if(1!==t.length)throw new Error(`${t.length} select elements found! There should only be one!`);if(1!==o.length)throw new Error(`${o.length} input elements found! There should only be one!`);l=t[0],d=o[0]}l.value=void 0!==a.Pirate?a.Pirate.Id.toString():"",d.checked=void 0!==a.Pirate}}ParseFoodClubBetsRedditThread(n){return o(this,void 0,void 0,(function*(){const o=e.map((e=>e.ShortName.toLowerCase()));let r=[];return yield fetch(n+".json").then((e=>e.json())).then((n=>{if(2!==n.length)return alert(`${n.length} items from array returned. There should be 2`),[];let a=this.FindBetForm(),l=document.createElement("p");l.style.fontWeight="bold",l.style.fontSize="16px",l.innerHTML=n[0].data.children[0].data.title,a.parentElement.appendChild(l);for(let a of n[1].data.children){const n=a.data.author,l=(a.data.score,a.data.body_html),m=new DOMParser,u=m.parseFromString(l,"text/html"),c=m.parseFromString(u.documentElement.textContent,"text/xml").getElementsByTagName("table");for(let a of c){if(!o.every((e=>a.textContent.toLowerCase().includes(e))))continue;const l=a.getElementsByTagName("tr");let m=[],u={Author:null,Rows:[]};u.Author=n;for(let n=0;n<l.length;n++){const r=l[n].children;if(0===n){for(let e=0;e<r.length;e++){const t=r[e],n=o.find((e=>t.textContent.toLowerCase().trim()===e));void 0!==n&&m.push({ArenaPosition:e,ArenaShortName:n})}if(5!==m.length)break}else{let o=[];for(let n=1;n<r.length-1;n++){var d=""===r[n].textContent?null:r[n].textContent,i=t.find((e=>e.ShortName.toLowerCase()===(null==d?void 0:d.toLocaleLowerCase().trim()))),s=m.find((e=>e.ArenaPosition===n)).ArenaShortName,h=e.find((e=>e.ShortName.toLowerCase()===s));o.push({Arena:h,Pirate:i})}if(5!==o.length)break;u.Rows.push({BetNumber:n,Bets:o})}}u.Rows.length>=10&&r.push(u)}}})),r}))}FetchFoodClubBetsRedditThread(){return o(this,void 0,void 0,(function*(){let e=null;let t="https://old.reddit.com/r/neopets.json",o=0;for(;++o<=5&&null===e;)yield fetch(t).then((e=>e.json())).then((o=>{t=`https://old.reddit.com/r/neopets.json?after=${o.data.after}`;for(let t of o.data.children){const o=t.data.title.toLowerCase(),n=t.data.link_flair_text,r=t.data.url;if("Food Club"!==n.trim())continue;const a={year:"numeric",month:"long",day:"numeric"},l=new Date,d=l.getMonth(),i=l.getDate(),s=l.getFullYear();if(new Date(s,d,i).toLocaleString(void 0,{month:"long"}),[new Date(s,d,i).toLocaleString(void 0,a).toLowerCase(),new Date(s,d,i+1).toLocaleString(void 0,a).toLowerCase()].find((e=>o.includes(e)))){e=r;break}}}));return e}))}}})();